<?xml version="1.0" encoding="utf-8"?>
<openerp>
	<data noupdate="0">
		
		<record id="view_order_tree_invoicing_plan" model="ir.ui.view">
            <field name="name">sale.order.tree.invoicing_plan</field>
            <field name="model">sale.order</field>
            <field name="type">tree</field>
            <field name="inherit_id" ref="sale.view_order_tree"/>
            <field name="priority">2</field>
            <field name="arch" type="xml">
	            <data>
					<field name="state" position="after">
						<field name="contract_ok"/>
					</field>
				</data>
			</field>
		</record>
            
		<record model="ir.ui.view" id="view_order_form_invoicing_plan">
			<field name="name">sale.order.form.invoicing_plan</field>
			<field name="model">sale.order</field>
			<field name="type">form</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
			<field eval="7" name="priority"/>
			<field name="arch" type="xml">
				<data>
					<field name="shipped" position="after">
					
						<label string='' />
						<label string='' />
						<label string='' />
						<label string='' />
						<field name="contract_ok" colspan="1"/>
					
					</field>
                    
					<xpath expr="/form/notebook/page[@string='Sales Order']/field[@name='order_line']/form/notebook/page[@string='Order Line']/field[@name='product_id']" position="replace">
		                    <field colspan="2"
	                           context="partner_id=parent.partner_id,quantity=product_uom_qty,pricelist=parent.pricelist_id,shop=parent.shop_id,uom=product_uom"
	                           name="product_id"
	                           on_change="product_id_change(parent.pricelist_id,product_id,product_uom_qty,product_uom,product_uos_qty,product_uos,name,parent.partner_id, 'lang' in context and context['lang'], True, parent.date_order, product_packaging, parent.fiscal_position, False)"
	                           />
	                        <field name="is_subscription" colspan="2"/>
					</xpath>
					<xpath expr="/form/notebook/page[@string='Sales Order']/field[@name='order_line']/tree/field[@name='discount']" position="before">
	                    <field name="invoicing_plan_id" attrs="{'invisible':[('is_subscription', '=', False)]}" />
	                    <field name="invoicing_start_date" attrs="{'invisible':[('is_subscription', '=', False)],'required':[('invoicing_plan_id', '!=', False)]}" />
	                    <field name="commitment_end_date" attrs="{'invisible':[('is_subscription', '=', False)]}" />
	                    <field name="invoicing_next_date" readonly="1" groups="base.group_extended" attrs="{'invisible': [('is_subscription', '=', False)]}" />
	                    <field name="state" groups="base.group_extended"/>
	                    <button name="button_confirm" string="Confirm" groups="base.group_extended" attrs="{'invisible': [('is_subscription', '=', False)]}" states="draft" icon="STOCK_OK" type="object"/>
	                    <button name="button_cancel" string="Cancel" groups="base.group_extended" attrs="{'invisible': [('is_subscription', '=', False)]}" states="confirmed" icon="STOCK_CANCEL" type="object"/>
	                    
					</xpath>
					<xpath expr="/form/notebook/page[@string='Sales Order']/field[@name='order_line']/form/notebook" position="inside">
	                    <page string="Subscription information" attrs="{'invisible': [('is_subscription', '=', False)]}">
	                    	<group string="General information" colspan="4">
	                    		<field name="invoicing_plan_id" colspan="2"/>
		                    	<field name="invoicing_start_date" colspan="2" attrs="{'readonly':[('state','!=','draft')]}" on_change="invoicing_start_date_change(invoicing_start_date,invoicing_plan_id)"/>
		                    	<field name="commitment_end_date" colspan="2"/>
		                    	<field name="invoicing_next_date" colspan="2" readonly="1" groups="base.group_extended"  />
		                    	<field name="detail_periods"  colspan="2" groups="base.group_extended"  />
		                    	<group colspan="2">
		                    		<field name="commitment_state" colspan="1" readonly="1"/>
		                    		<button name="button_change_commitment" string="Change commitment" colspan="1" type="object"/>
		                    	</group>
                        	</group>
	                    	
	                    	<group string="Invoicing info" colspan="4">
		                    	
	                        	<field name="residual" readonly="1" groups="base.group_extended" attrs="{'invisible':[('is_subscription', '=', False)]}" />
	                        	
                        	
	                    	<field name="line_invoice_info_ids" string="Invoicing Periods" nolabel="1" colspan="4">
	                    		<tree string="Periods">
	                    			<field name="name" />
                                    <field name="periods" />
                                    <field name="invoiced" />
                                    <field name="to_invoice" />
                                    <field name="start_date" />
                                    <field name="stop_date" />
                                    <field name="order_line_id" />
	                    		</tree>
	                    		<form string="Period">
	                    			<group colspan="4">
	                    			<field name="name" />
                                    <field name="periods" />
                                    <field name="invoiced" />
                                    <field name="to_invoice" />
                                    </group>
                                    <group colspan="4">
                                    <field name="start_date" />
                                    <field name="stop_date" />
                                    </group>
                                    <field name="order_line_id" colspan="4"/>
                                    <field name="invoice_line_ids" colspan="4"/>
                                    
	                    		</form>
	                    	</field>
	                    	</group>
	                    	
	                    </page>
					</xpath>
					<notebook position="inside">
						<page string="Contract information" attrs="{'invisible':[('contract_ok', '=', False)]}">
							<field  name="invoicing_start_date"  colspan="2" />
							<group colspan="2">
								<field name="periodicity" />
								<field name="uop" />
							</group>
							<field  name="invoicing_next_date"/>
						</page>
					</notebook>
				</data>
			</field>
		</record>
	</data>
</openerp>
